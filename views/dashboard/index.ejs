<!-- views/dashboard/index.ejs -->
<div class="container py-4"> 
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Dashboard Pemantauan Energi</h2>
    <p id="waktuSekarang" class="badge rounded-pill bg-primary text-white" style="font-size:0.8rem"></p>
  </div>

  <!-- Helper EJS: format jam desimal -> "X jam Y menit" -->
  <%
    function toHM(hours){
      const totalMin = Math.round((Number(hours) || 0) * 60);
      const j = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      return (j > 0 ? `${j} jam ${m} menit` : `${m} menit`);
    }
  %>

  <!-- Input Kapasitas + Info Kapasitas Terpasang (tampilkan VA dari W * 1.25) -->
  <div class="alert alert-info p-2 rounded">
    <div class="d-flex flex-wrap align-items-center mb-3 w-100">
      <h6 class="mb-2 mb-md-0 me-md-4 w-100 w-md-auto">Input Kapasitas Daya Listrik :</h6>

      <form id="kapasitasForm" action="/kapasitas" method="POST"
            class="d-flex flex-wrap align-items-center gap-2 w-100 w-md-auto">
        <input type="number" name="kapasitas_daya" id="kapasitas_daya"
               class="form-control form-control-sm flex-grow-1" style="max-width:200px;"
               placeholder="cth: 1300 (VA)" required />
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-save me-1"></i> Simpan
        </button>
      </form>

      <!-- ✅ Teks ringkas: "Kapasitas terpasang: 1300 VA" (dari watt × 1.25) -->
      <div class="ms-auto mt-3 mt-md-0 d-flex flex-column text-end">
        <span class="fw-semibold">Kapasitas terpasang:</span>
        <span class="badge bg-primary fs-6" id="kapasitas-terpasang-watt">
          <% if (Number(kapasitasTerpasangW) > 0) { %>
            <%= Math.round(Number(kapasitasTerpasangW) * 1.25) %> VA
          <% } else { %>
            Belum diinput
          <% } %>
        </span>
      </div>
    </div>
  </div>

  <%
    let persenLimit = null, isLimitHariIni = false;

    if (limit) {
      persenLimit = Math.min(100, Math.round((totalEnergiHariIni / limit.batas_kwh) * 100));

      function toJakartaDateOnly(dateString) {
        const parts = new Date(dateString).toLocaleString('en-CA', {
          timeZone: 'Asia/Jakarta',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).split(',')[0];
        const [y, m, d] = parts.split('-').map(Number);
        return new Date(y, m - 1, d);
      }

      const hariIni = toJakartaDateOnly(new Date());
      const mulai = toJakartaDateOnly(limit.tanggal_mulai);
      const selesai = toJakartaDateOnly(limit.tanggal_selesai);

      isLimitHariIni = hariIni >= mulai && hariIni <= selesai;
    }
  %>

  <% if (isLimitHariIni) { %>
    <div id="limit-container" class="alert alert-warning d-flex justify-content-between align-items-center">
      <div>
        Periode Limit:
        <strong><%= new Date().toLocaleDateString('id-ID', { dateStyle: 'long', timeZone: 'Asia/Jakarta' }) %></strong><br />
        Waktu: <strong>00:00 - 23:59</strong><br />
        Total Pemakaian:
        <strong id="total-energi"><%= totalEnergiHariIni.toFixed(2) %> kWh</strong><br />
        Batas Energi:
        <strong id="batas-energi" data-only-number="true"><%= limit.batas_kwh %> kWh</strong>
      </div>

      <div style="width: 250px">
        <div class="progress" style="height: 15px">
          <div
            id="progress-bar"
            class="progress-bar <%= persenLimit < 60 ? 'bg-success' : persenLimit < 80 ? 'bg-warning' : 'bg-danger' %>"
            role="progressbar"
            style="width: <%= persenLimit %>%"
            aria-valuenow="<%= persenLimit %>"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            <%= typeof persenLimit === 'number' ? persenLimit + '%' : '0%' %>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
    <% dataTerbaru.forEach(function(item) { 
         const kuota     = Number(item.perangkat.kuota_durasi ?? 0);
         const terpakai  = Number(item.perangkat.durasi_terpakai ?? 0);
         const sisa      = Math.max(0, kuota - terpakai);
         const persenDur = kuota > 0 ? Math.min(100, Math.round((terpakai/kuota)*100)) : 0;
         const showQuotaBox = Boolean(isLimitHariIni && !item.perangkat.penjadwalan_aktif && kuota > 0);

         let skor = Number(item.perangkat.skor_prioritas || 0);
         let kategori = (skor <= 0.4) ? 'Rendah' : (skor <= 0.7 ? 'Sedang' : 'Tinggi');
    %>
    <div class="col">
      <div
        class="card h-100 border-<%= item.perangkat.prioritas === 'Vital' ? 'danger' : item.perangkat.prioritas === 'Sekunder' ? 'warning' : 'secondary' %>"
      >
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong><%= item.perangkat.nama_perangkat %></strong><br />
            <!-- "Jenis Perangkat" dihilangkan sesuai permintaan -->
            <small class="text-muted">Penjadwalan: <%= item.perangkat.penjadwalan_aktif ? 'Aktif' : 'Tidak' %></small><br>
            <small class="text-muted">
              Skor Prioritas: <%= kategori %> (<%= skor.toFixed(4) %>)
            </small>

            <% if (item.perangkat.diblokir_limit) { %>
              <br /><small class="text-danger"><i class="fas fa-ban"></i> Diblokir oleh limit energi</small>
            <% } %>
          </div>
          <span
            class="badge rounded-pill bg-<%= item.perangkat.status === 'ON' ? 'success' : 'danger' %>"
          >
            <i class="fas fa-circle me-1"></i><%= item.perangkat.status %>
          </span>
        </div>

        <div class="card-body">
          <% if (item.perangkat.penjadwalan_aktif) { %>
            <div class="alert alert-warning p-1 mb-2 text-center">
              <i class="fas fa-clock me-1"></i> Perangkat dikendalikan oleh jadwal
            </div>
          <% } %>
          <% if (item.perangkat.diblokir_limit) { %>
            <div class="alert alert-danger p-1 mb-2 text-center">
              <i class="fas fa-exclamation-triangle me-1"></i> Tidak dapat dinyalakan karena limit energi
            </div>
          <% } %>

          <div class="d-flex gap-2 mt-2 mb-3">
            <button
              type="button"
              class="btn btn-<%= item.perangkat.status === 'ON' ? 'success' : 'outline-success' %> btn-sm flex-fill"
              data-device-id="<%= item.perangkat.id %>"
              data-command="ON"
              data-penjadwalan="<%= item.perangkat.penjadwalan_aktif ? 'true' : 'false' %>"
              <%= item.perangkat.diblokir_limit
                    ? 'disabled title="Tidak dapat dinyalakan karena limit energi tercapai"'
                    : `title="${item.perangkat.penjadwalan_aktif ? 'Akan override jadwal' : 'Kontrol manual'}"` %>
            >
              <i class="fas fa-power-off me-1"></i> ON
            </button>

            <button
              type="button"
              class="btn btn-<%= item.perangkat.status === 'OFF' ? 'danger' : 'outline-danger' %> btn-sm flex-fill"
              data-device-id="<%= item.perangkat.id %>"
              data-command="OFF"
              data-penjadwalan="<%= item.perangkat.penjadwalan_aktif ? 'true' : 'false' %>"
              title="<%= item.perangkat.penjadwalan_aktif ? 'Akan override jadwal' : 'Kontrol manual' %>"
            >
              <i class="fas fa-power-off me-1"></i> OFF
            </button>
          </div>

          <hr />

          <% if (item.data) { %>
            <p>Tegangan: <strong id="volt-<%= item.perangkat.id %>"><%= item.data.volt %></strong> V</p>
            <p>Arus: <strong id="ampere-<%= item.perangkat.id %>"><%= item.data.ampere %></strong> A</p>
            <p>Daya: <strong id="watt-<%= item.perangkat.id %>"><%= item.data.watt %></strong> W</p>
            <p>Energi: <strong id="energy-<%= item.perangkat.id %>"><%= item.data.energy %></strong> kWh</p>
          <% } else { %>
            <p class="text-muted">Belum ada data</p>
          <% } %>

          <!-- BOX KUOTA / TERPAKAI / SISA (muncul hanya jika limit & tidak dijadwalkan) -->
          <% if (showQuotaBox) { %>
            <div class="mt-3 p-2 rounded border bg-light">
              <div class="d-flex justify-content-between small text-muted">
                <span>Kuota</span>
                <span>
                  <strong id="kuota-<%= item.perangkat.id %>" data-raw="<%= kuota %>"><%= toHM(kuota) %></strong>
                </span>
              </div>
              <div class="d-flex justify-content-between small text-muted">
                <span>Terpakai</span>
                <span>
                  <strong id="durasi-<%= item.perangkat.id %>" data-raw="<%= terpakai %>"><%= toHM(terpakai) %></strong>
                </span>
              </div>
              <div class="d-flex justify-content-between small text-muted">
                <span>Sisa</span>
                <span>
                  <strong id="sisa-<%= item.perangkat.id %>" data-raw="<%= sisa %>"><%= toHM(sisa) %></strong>
                </span>
              </div>
              <div class="progress mt-2" style="height:8px">
                <div id="durasi-bar-<%= item.perangkat.id %>" class="progress-bar bg-primary" style="width:<%= persenDur %>%"></div>
              </div>
            </div>
          <% } %>

        </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<!-- Modal Konfirmasi -->
<div
  class="modal fade"
  id="modalKonfirmasiManual"
  tabindex="-1"
  aria-labelledby="modalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalLabel">Konfirmasi Kontrol Manual</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        Perangkat ini Sekunder dikendalikan oleh <strong>penjadwalan otomatis</strong>.<br />
        Apakah Anda yakin ingin mengubah status perangkat secara manual?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnKonfirmasiManual">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/dashboard.js"></script>

<script>
  function updateWaktuSekarang() {
    const el = document.getElementById("waktuSekarang");
    const hariNama = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
    const bulanNama = ["Jan","Feb","Mar","April","Mei","Juni","Juli","Agu","Sep","Okt","Nov","Des"];
    const now = new Date();
    const txt = `${hariNama[now.getDay()]}, ${String(now.getDate()).padStart(2,'0')} ${bulanNama[now.getMonth()]} ${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
    el.textContent = txt;
  }
  updateWaktuSekarang();
  setInterval(updateWaktuSekarang, 1000);
</script>
